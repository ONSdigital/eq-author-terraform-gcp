# Configure a local setup
- Create a project
- Enable the API's `Cloud Run`, `Firestore`, `Secrets manager`
- In the images project give Cloud Run Service Agent (`service-<project_number>@serverless-robot-prod.iam.gserviceaccount.com)` 
the followng roles
    - `Storage object viewer`
- In the DNS project give your account (your email) these roles
    - `DNS Administrator`
- Select Firestore native mode in the firestore console
- Create a bucket for the terraform state called `<project_id>-terraform`
- Add the following secrets in secret manager
    - `react_app_firebase_project_id`
    - `react_app_firebase_api_key`
- in either project-default or project prod rename `backend.example.tfvars` to `backend.tfvars` and update the following
    - bucket (The bucket for the state eg `<project_id>-terraform`)
- in either project-default or project prod rename `terraform.example.tfvars` to `terraform.tfvars` and update the following
    - _PROJECT_ID (Your project id)
    - _REGION (eg. `europe-west2`)
    - _DOMAIN_PREFIX (This will be put before the domain names and should not already exist, eg. `dev`)
    - _ONS_IPS (an array of ip's eg. `[/'xxx.xxx.xxx.xxx/32/", /"xxx.xxx.xxx.xxx/32/" ]`)
    - _DEV_IPS (an array of ip's eg. `[/'xxx.xxx.xxx.xxx/32/", /"xxx.xxx.xxx.xxx/32/" ]`)
    - _DNS_PROJECT_ID (The name of the project hosting the DNS zone)
    - _MANAGED_ZONE_NAME (The name of the managed DNS zone)
    - _APPLICATION_IMAGE_REPOSITORY
- cd into either project-default or project prod
- Run "gcloud auth application-default login"
- Run "gcloud config set project <project_id>"
- Run "terraform init -backend-config backend.tfvars"
- Run "terraform apply -var-file terraform.tfvars"

# Configure cloud build pipeline and GCP project
- Create a project
- Enable the API's `Cloud Run`, `Firestore`, `Secrets manager`, `Cloud Build`, `service usage api`, `Cloud resource manager`
- In the images project give Cloud Run Service Agent (`service-<project_number>@serverless-robot-prod.iam.gserviceaccount.com)` 
the followng roles
    - `Storage object viewer`
- In the DNS project give the Cloudbuild Account (`<project_number>@cloudbuild.gserviceaccount.com`) these roles
    - `DNS Administrator`
- Give Cloudbuild Account (`<project_number>@cloudbuild.gserviceaccount.com`) the following roles
    - `Editor`
    - `Project IAM Admin`
- Select Firestore native mode in the firestore console
- Add the following secrets in secret manager
    - `react_app_firebase_project_id`
    - `react_app_firebase_api_key`
- Create a bucket for the terraform state called `<project_id>-terraform`
- Create a cloud build trigger for this repo, set either cloudbuild.yaml or cloudbuild-prod.yaml for the env you want to build. Add the following environment varibles to the trigger
    - _BUCKET (The bucket to store the terraform state eg. `<project_id>-tfstate`)
    - _PREFIX (The folders path in the bucketfor the state eg. `terraform/state`) 
    - _PROJECT_ID (Your project id)
    - _REGION (eg. `europe-west2`)
    - _DOMAIN_PREFIX (This will be put before the domain names, eg. `prod`, `preprod`, `staging`)
    - _ONS_IPS (an array of ip's eg. `[/'xxx.xxx.xxx.xxx/32/", /"xxx.xxx.xxx.xxx/32/" ]`)
    - _DEV_IPS (an array of ip's eg. `[/'xxx.xxx.xxx.xxx/32/", /"xxx.xxx.xxx.xxx/32/" ]`)
    - _DNS_PROJECT_ID (The name of the project hosting the DNS zone)
    - _MANAGED_ZONE_NAME (The name of the managed DNS zone)
    - _APPLICATION_IMAGE_REPOSITORY
- cd into either project-default or project prod
- Run the trigger
